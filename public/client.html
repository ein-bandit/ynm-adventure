<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>community client</title>
    <script src="components/jquery/dist/jquery.min.js"></script>
    <script>
        if (!!window.EventSource) {

            var eventCounter = 0;

            function connect() {

                var source = new EventSource("/events", {withCredentials: false});
                $('#connect').css('display', 'none');
                $('#wait').css('display', 'block');

                source.onmessage = function (event) {
                    console.log("a new voting arrived!");
                    var data = JSON.parse(event.data);
                    console.log(event);
                    if (data.eventNr > eventCounter) {
                        if (event.type === 'open' || event.type === 'message') {
                            $('#wait').css('display', 'none');
                        }
                        //disabled because server interval stops after timeout
                        //if (data.votingEnabled === true) {
                        $('#answers').css('display', 'block');
                        eventCounter = data.eventNr;
                        startVoting(data.votingTime);
                        //}
                    }
                };
                source.onerror = function (err) {
                    console.log(err);
                    $.get('/disconnect').then(function () {
                        $('#connect').css('display', 'block');
                    });
                };
            }

        } else {
            alert("Sorry, your browser does not work with this app. (EventSource not available)");
        }
        function sendAnswer(answer) {
            $.post('answer', {data: answer});
            $('#answers').css('display', 'none');
            $('#wait').css('display', 'block');
            timeCounter = 0;
        }
        var timeCounter;
        function startVoting(time) {
            timeCounter = 0;
            var interval = setInterval(function () {
                timeCounter++;
                if (timeCounter == time) {
                    $('#wait').css('display', 'block');
                    $('#answers').css('display', 'none');
                    clearInterval(interval);
                }
            }, 1000);
        }
    </script>
</head>
<body>
<h1>i am the client</h1>

<button id="connect" onclick="connect()">connect</button>
<div id="answers" style="display:none">

    <button onclick="sendAnswer(0)">yes</button>
    <button onclick="sendAnswer(1)">no</button>
</div>
<p style="color:red; display:none" id="wait">please wait...</p>
</body>
</html>