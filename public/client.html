<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>community client</title>
    <script src="components/jquery/dist/jquery.min.js"></script>
    <style>
        html {
            background-repeat: no-repeat;
            background-size: cover;
        }

        #dummy {
            padding-top: 35%;
        }

        #answers {
            width: 60%;
            margin: 0 auto;
            height: 100%;
            display: none;
        }

        #btn-yes, #btn-no, #btn-dummy {
            width: 100%;
            height: 100%;
            padding-bottom: 36%;
            background-size: 100%;

            cursor: pointer;
        }

        #btn-dummy {
            cursor: default;
        }

    </style>
    <script>
        var bgs = {};
        bgs = {
            background_active: '/images?image=client_background',
            background_inactive: '/images?image=client_background_inactive'
        };
        var source;
        $("document").ready(function () {
            $("html").css("background-image", 'url(' + bgs['background_active'] + ')');
            $("html").css("background-image", 'url(' + bgs['background_inactive'] + ')');
            $("#btn-yes").css("background-image", 'url(/images?image=client_button_yes)');
            $("#btn-no").css("background-image", 'url(/images?image=client_button_no)');

            connect();
        });
        $(window).on("beforeunload", function () {
            source.close();
        });
        if (!!window.EventSource) {

            var eventCounter = 0;


            function connect() {

                source = new EventSource("/events", {withCredentials: false});
                $('#connect').css('display', 'none');

                source.onmessage = function (event) {
                    console.log("a new voting arrived!");
                    var data = JSON.parse(event.data);
                    console.log(event);
                    if (data.eventNr > eventCounter) {
                        if (event.type === 'open' || event.type === 'message') {
                            $('html').css('background-image', 'url(' + bgs['background_active'] + ')');
                        }
                        //disabled because server interval stops after timeout
                        //if (data.votingEnabled === true) {
                        $('#answers').css('display', 'block');
                        eventCounter = data.eventNr;
                        startVoting(data.votingTime);
                        //}
                    }
                };
                source.onerror = function (err) {
                    console.log(err);
                    alert("lost connection, please refresh page.");
                };

            }

        } else {
            alert("Sorry, your browser does not work with this app. (EventSource not available)");
        }
        function sendAnswer(answer) {
            $.post('answer', {data: answer});
            $('#answers').css('display', 'none');
            $('html').css('background-image', 'url(' + bgs['background_inactive'] + ')');
            timeCounter = 0;
        }
        var timeCounter;
        function startVoting(time) {
            timeCounter = 0;
            var interval = setInterval(function () {
                timeCounter++;
                if (timeCounter == time) {
                    $('html').css("background-image", 'url(' + bgs['background_inactive'] + ')');
                    $('#answers').css('display', 'none');
                    clearInterval(interval);
                }
            }, 1000);
        }
    </script>
</head>
<body>
<div id="dummy"></div>
<div id="answers">
    <a onclick="sendAnswer(0)">
        <div id="btn-yes"></div>
    </a>
    <a>
        <div id="btn-dummy"></div>
    </a>
    <a onclick="sendAnswer(1)">
        <div id="btn-no"></div>
    </a>
</div>
</body>
</html>